<!doctype html>
<html lang="en" data-theme="lofi">
	<head>
		<script>
			if (!window.location.href.endsWith("/")) {
				// Make sure we have a trailing slash.
				// sveltekit's trailingSlash is not available with hash routing
				window.location.replace(window.location.href + "/");
			}
		</script>
		<meta charset="utf-8" />
		<link rel="apple-touch-icon" sizes="180x180" href="%sveltekit.assets%/apple-touch-icon.png" />
		<link rel="icon" type="image/png" href="%sveltekit.assets%/favicon.png" />
		<link rel="icon" type="image/svg" href="%sveltekit.assets%/favicon.svg" />
		<link rel="mask-icon" href="%sveltekit.assets%/favicon.png" color="#000" />
		<meta name="viewport" content="width=device-width" />
		%sveltekit.head%
		<style>
			#app-splash {
				position: fixed;
				inset: 0;
				display: grid;
				place-content: center;
				text-align: center;
				font-family: system-ui, sans-serif;
				background: #fafafa;
				z-index: 10000;
			}

			#app-splash svg {
				width: 100px;
				margin: 0 auto 1.5rem;
			}

			#app-splash path {
				fill: none;
				stroke: #222;
				stroke-width: 16;
				stroke-dasharray: 3800;
				animation: draw 2s ease-in-out infinite alternate;
			}

			#app-splash.error path {
				stroke: #dc2626;
				stroke-dashoffset: 0;
			}

			@keyframes draw {
				from {
					stroke-dashoffset: 3800;
				}
				to {
					stroke-dashoffset: 0;
				}
			}

			#app-splash h1 {
				font-size: 1.1rem;
				font-weight: 600;
				margin: 0;
				line-height: 1.2;
			}
			#app-splash h2 {
				font-size: 0.9rem;
				font-weight: 400;
				opacity: 0.6;
				margin: 0.25rem 0 0;
				line-height: 1.2;
			}

			#app-splash.error h1 {
				color: #dc2626;
			}

			#app-splash .error-details {
				font-size: 0.75rem;
				opacity: 0.5;
				margin-top: 0.5rem;
				max-width: 300px;
				word-break: break-word;
			}
			#app-splash .action-btn {
				margin-top: 1.5rem;
				padding: 0.75rem 1.5rem;
				background: #1a1a1a;
				opacity: 40;
				color: white;
				outline: 1px solid #eee;
				border-radius: 0.5rem;
				font-size: 0.9rem;
				font-weight: 500;
				cursor: pointer;
				transition: background 0.15s;
			}

			#app-splash .action-btn:hover {
				outline: 2px solid #eee;
				font-weight: 600;
			}

			@media (prefers-color-scheme: dark) {
				#app-splash {
					background: #1a1a1a;
					color: #eee;
				}
				#app-splash path {
					stroke: #eee;
				}
				#app-splash.error path {
					stroke: #f87171;
				}
				#app-splash.error h1 {
					color: #f87171;
				}
			}
			#app-splash.bye {
				animation: bye 0.2s ease-in forwards;
				will-change: transform, opacity;
			}

			@keyframes bye {
				to {
					opacity: 0;
					transform: translateY(100%);
				}
			}
		</style>
	</head>
	<body>
		<div id="app-splash">
			<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 1000">
				<path
					d="m782.62 493.26v-294.29c0-31.788-11.28-62.55-33.839-85.109-22.559-23.584-53.321-36.915-86.135-36.915-65.626 0-118.95 53.321-118.95 118.95v535.27h467.59c26.661 0 49.22 20.508 50.245 46.144 1.0254 27.686-21.534 51.271-49.22 51.271h-567.05v-717.79c0-19.483-15.381-34.864-34.864-34.864s-34.864 15.381-34.864 34.864v788.54h634.73c66.652 0 123.05-54.347 122.02-122.02-1.0254-64.601-54.347-117.92-119.97-117.92h-397.86v-465.54c0-26.661 21.534-48.194 48.194-48.194 11.28 0 23.584 4.1016 31.788 11.28 11.28 9.2287 17.432 23.584 17.432 37.94v367.1h384.53c19.483 0 34.864-15.381 34.864-34.864 0-19.483-15.381-34.864-34.864-34.864h-313.78z"
					transform="translate(-250, 0)"
				/>
			</svg>
			<div>
				<h1 id="splash-title">Librocco is loading. Hang tight!</h1>
				<h2 id="splash-subtitle">Or hang loose â€“ your choice.</h2>
				<p id="splash-error" class="error-details" style="display: none"></p>
				<button id="splash-action" class="action-btn" style="display: none">Reset Database</button>
			</div>
		</div>
		<script>
			// Static message map for each initialization phase
			const splashMessages = {
				// The idle state is typed above in the HTML as it should be visible immediately on load
				idle: { title: "", subtitle: "" },
				loading: { title: "Initialising the database", subtitle: "Waking the workers and heating the coffee..." },
				migrating: {
					title: "Migrating the database",
					subtitle: "Updating to the latest version..."
				},
				error: {
					title: "Migration Error",
					subtitle:
						"There was a problem updating the database. Click Reset Database below to continue. Your data will be re-synced from the server."
				}
			};

			// Callback for init-store to notify phase changes
			window.__dbInitUpdate = function (phase, error) {
				const splash = document.getElementById("app-splash");
				// If splash has already been removed (after "ready" phase), nothing to update
				if (!splash) return;

				const title = document.getElementById("splash-title");
				const subtitle = document.getElementById("splash-subtitle");
				const errorEl = document.getElementById("splash-error");
				const actionBtn = document.getElementById("splash-action");

				// Guard against missing elements (shouldn't happen, but be safe)
				if (!title || !subtitle) return;

				const msg = splashMessages[phase] || splashMessages.idle;
				title.textContent = msg.title;
				subtitle.textContent = msg.subtitle;

				if (phase === "error") {
					splash.classList.add("error");
					if (error && error.message) {
						errorEl.textContent = error.message;
						errorEl.style.display = "block";
					}
					actionBtn.style.display = "inline-block";
				} else if (phase === "ready") {
					splash.classList.add("bye");
					splash.addEventListener("animationend", function () {
						splash.remove();
					});
				} else {
					splash.classList.remove("error");
					errorEl.style.display = "none";
					actionBtn.style.display = "none";
				}
			};

			// OPFS nuke function - deletes the database files and reloads
			async function nukeDatabase() {
				const nukeBtn = document.getElementById("splash-action");
				nukeBtn.disabled = true;
				nukeBtn.textContent = "Resetting...";

				try {
					// Get database name from localStorage (default: "dev")
					const dbname = localStorage.getItem("librocco-current-db") || "dev";

					// Get OPFS root directory
					const root = await navigator.storage.getDirectory();

					// Helper to safely remove a file if it exists
					async function removeIfExists(name) {
						try {
							await root.removeEntry(name);
						} catch (e) {
							// File doesn't exist or can't be removed - that's ok
						}
					}

					// Remove the database files
					await removeIfExists(dbname);
					await removeIfExists(dbname + "-wal");
					await removeIfExists(dbname + "-journal");

					// Reload the page to reinitialize
					window.location.reload();
				} catch (e) {
					console.error("Failed to nuke database:", e);
					nukeBtn.textContent = "Reset Failed";
					nukeBtn.disabled = false;
				}
			}

			// Wire up button handlers
			document.getElementById("splash-action").onclick = nukeDatabase;
		</script>
		<div style="height: 100%">%sveltekit.body%</div>
	</body>
</html>
