name: Checks
"on":
  push:
    branches-ignore:
    - ci-debug/*
    - wip/**
    - vfs-benchmark/**
jobs:
  build-cr-sqlite:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      rebuild: ${{ steps.ts.outputs.rebuild }}
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
        lfs: false
        fetch-depth: 0
    - name: Test if artefacts are stale
      id: ts
      shell: bash
      run: echo "rebuild=yes" >> "$GITHUB_OUTPUT"
    - uses: actions/setup-node@v4
      if: steps.ts.outputs.rebuild == 'yes'
      with:
        node-version: "20"
    - name: Install Rust 1.85.0
      if: steps.ts.outputs.rebuild == 'yes'
      uses: actions-rs/toolchain@v1
      with:
        toolchain: 1.85.0
        override: true
    - name: install wasm-pack
      if: steps.ts.outputs.rebuild == 'yes'
      run: cargo install wasm-pack
    - name: install pnpm
      if: steps.ts.outputs.rebuild == 'yes'
      run: npm install -g 'pnpm@<9'
    - name: Build cr-sqlite
      if: steps.ts.outputs.rebuild == 'yes'
      run: ./scripts/build_vlcn.sh
    - name: Check that the build went fine
      run: git status; ls -l 3rd-party/artefacts/
    - name: upload to later jobs
      if: steps.ts.outputs.rebuild == 'yes'
      uses: actions/upload-artifact@v4
      with:
        name: built-vlcn-artefacts
        path: 3rd-party/artefacts/
    - name: Mark cached version
      run: cp 3rd-party/artefacts_version.txt 3rd-party/artefacts/version-cached.txt
    - name: Commit updated assets
      if: github.ref == 'refs/heads/compile-assets'
      run: bash scripts/commit-artefacts.sh
    - name: Push changes
      if: github.ref == 'refs/heads/compile-assets'
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: compile-assets
  js-search-test:
    name: JS-Search Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: build-cr-sqlite
    permissions:
      id-token: write
      contents: read
      checks: write
    steps:
    - name: Checkout repository and submodules
      uses: actions/checkout@v4
      with:
        submodules: recursive
        lfs: false
    - uses: actions/setup-node@v4
      with:
        node-version: "20"
    - name: Compute desired compiled artifact version
      run: ./scripts/compute_artefacts_version.sh
    - uses: actions/download-artifact@v4
      with:
        name: built-vlcn-artefacts
        path: 3rd-party/artefacts
      if: ${{ !cancelled() && needs.build-cr-sqlite.outputs.rebuild == 'yes' }}
    - name: Load cached cr-sqlite artefacts
      uses: actions/cache/restore@v4
      with:
        path: 3rd-party/artefacts
        key: ${{ runner.os }}-cr-sqlite-artefacts-${{ hashFiles('3rd-party/artefacts_version.txt') }}
    - name: Cache node modules
      uses: actions/cache@v4
      with:
        path: |
          ~/.rush
          ~/.pnpm-store
          common/temp
          ./common/temp/node_modules/
        key: ${{ runner.os }}-modules-node16-v2-${{ hashFiles('**/pnpm-lock.yaml') }}
    - name: Add local rush scripts to PATH
      run: echo "${PWD}"/common/scripts >> $GITHUB_PATH
    - name: Install packages
      run: rush update
    - name: Build packages
      run: rush build
    - name: Run tests
      run: cd pkg/js-search && rushx test:ci
    - name: Test Report
      uses: dorny/test-reporter@v1
      if: success() || failure()
      with:
        name: JS-Search Tests
        path: pkg/js-search/junit.xml
        reporter: jest-junit
  book-data-extension-test:
    name: Book data extension Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: build-cr-sqlite
    permissions:
      id-token: write
      contents: read
      checks: write
    steps:
    - name: Checkout repository and submodules
      uses: actions/checkout@v4
      with:
        submodules: recursive
        lfs: false
    - uses: actions/setup-node@v4
      with:
        node-version: "20"
    - name: Compute desired compiled artifact version
      run: ./scripts/compute_artefacts_version.sh
    - uses: actions/download-artifact@v4
      with:
        name: built-vlcn-artefacts
        path: 3rd-party/artefacts
      if: ${{ !cancelled() && needs.build-cr-sqlite.outputs.rebuild == 'yes' }}
    - name: Load cached cr-sqlite artefacts
      uses: actions/cache/restore@v4
      with:
        path: 3rd-party/artefacts
        key: ${{ runner.os }}-cr-sqlite-artefacts-${{ hashFiles('3rd-party/artefacts_version.txt') }}
    - name: Cache node modules
      uses: actions/cache@v4
      with:
        path: |
          ~/.rush
          ~/.pnpm-store
          common/temp
          ./common/temp/node_modules/
        key: ${{ runner.os }}-modules-node16-v2-${{ hashFiles('**/pnpm-lock.yaml') }}
    - name: Add local rush scripts to PATH
      run: echo "${PWD}"/common/scripts >> $GITHUB_PATH
    - name: Install packages
      run: rush update
    - name: Build packages
      run: rush build
    - name: Run tests
      run: cd plugins/book-data-extension && rushx test:ci
  web-client-test:
    name: Web Client Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: build-cr-sqlite
    permissions:
      id-token: write
      contents: read
      checks: write
    steps:
    - name: Checkout repository and submodules
      uses: actions/checkout@v4
      with:
        submodules: recursive
        lfs: false
    - uses: actions/setup-node@v4
      with:
        node-version: "20"
    - name: Compute desired compiled artifact version
      run: ./scripts/compute_artefacts_version.sh
    - uses: actions/download-artifact@v4
      with:
        name: built-vlcn-artefacts
        path: 3rd-party/artefacts
      if: ${{ !cancelled() && needs.build-cr-sqlite.outputs.rebuild == 'yes' }}
    - name: Load cached cr-sqlite artefacts
      uses: actions/cache/restore@v4
      with:
        path: 3rd-party/artefacts
        key: ${{ runner.os }}-cr-sqlite-artefacts-${{ hashFiles('3rd-party/artefacts_version.txt') }}
    - name: Cache node modules
      uses: actions/cache@v4
      with:
        path: |
          ~/.rush
          ~/.pnpm-store
          common/temp
          ./common/temp/node_modules/
        key: ${{ runner.os }}-modules-node16-v2-${{ hashFiles('**/pnpm-lock.yaml') }}
    - name: Add local rush scripts to PATH
      run: echo "${PWD}"/common/scripts >> $GITHUB_PATH
    - name: Install packages
      run: rush update
    - name: Build packages
      run: rush build
    - name: Run tests
      run: cd apps/web-client && rushx test:ci
  e2e-test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    needs: build-cr-sqlite
    strategy:
      fail-fast: false
      matrix:
        shardIndex:
        - 1
        - 2
        - 3
        - 4
        - 5
        - 6
        shardTotal:
        - 6
    steps:
    - name: Checkout repository and submodules
      uses: actions/checkout@v4
      with:
        submodules: recursive
        lfs: false
    - uses: actions/setup-node@v4
      with:
        node-version: "20"
    - name: Compute desired compiled artifact version
      run: ./scripts/compute_artefacts_version.sh
    - uses: actions/download-artifact@v4
      with:
        name: built-vlcn-artefacts
        path: 3rd-party/artefacts
      if: ${{ !cancelled() && needs.build-cr-sqlite.outputs.rebuild == 'yes' }}
    - name: Load cached cr-sqlite artefacts
      uses: actions/cache/restore@v4
      with:
        path: 3rd-party/artefacts
        key: ${{ runner.os }}-cr-sqlite-artefacts-${{ hashFiles('3rd-party/artefacts_version.txt') }}
    - name: Cache node modules
      uses: actions/cache@v4
      with:
        path: |
          ~/.rush
          ~/.pnpm-store
          common/temp
          ./common/temp/node_modules/
        key: ${{ runner.os }}-modules-node16-v2-${{ hashFiles('**/pnpm-lock.yaml') }}
    - name: Add local rush scripts to PATH
      run: echo "${PWD}"/common/scripts >> $GITHUB_PATH
    - name: Install packages
      run: rush update
    - name: Build packages
      run: rush build
    - name: Build the app
      run: cd apps/web-client && rushx build:e2e
    - name: Download playwright browsers
      run: cd apps/e2e && npx playwright install
    - name: Run Playwright tests (shard ${{ matrix.shardIndex }}/${{ matrix.shardTotal }})
      run: cd apps/e2e && rushx test:ci
      env:
        PLAYWRIGHT_OPTIONS: --shard=${{ matrix.shardIndex }}/${{ matrix.shardTotal }}
        SHARD_INDEX: ${{ matrix.shardIndex }}
    - uses: actions/upload-artifact@v4
      if: always()
      with:
        name: e2e-blob-report-${{ matrix.shardIndex }}
        path: apps/e2e/blob-report
        retention-days: 2
    - uses: actions/upload-artifact@v4
      if: always()
      with:
        name: sync-server-logs-${{ matrix.shardIndex }}
        path: apps/web-client/server_output.log
        retention-days: 2
  lint-and-typecheck:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: build-cr-sqlite
    permissions:
      id-token: write
      contents: read
      checks: write
    steps:
    - name: Checkout repository and submodules
      uses: actions/checkout@v4
      with:
        submodules: recursive
        lfs: false
    - uses: actions/setup-node@v4
      with:
        node-version: "20"
    - uses: actions/download-artifact@v4
      with:
        name: built-vlcn-artefacts
        path: 3rd-party/artefacts
      if: ${{ !cancelled() && needs.build-cr-sqlite.outputs.rebuild == 'yes' }}
    - name: Load cached cr-sqlite artefacts
      uses: actions/cache/restore@v4
      with:
        path: 3rd-party/artefacts
        key: ${{ runner.os }}-cr-sqlite-artefacts-${{ hashFiles('3rd-party/artefacts_version.txt') }}
    - name: Cache node modules
      uses: actions/cache@v4
      with:
        path: |
          ~/.rush
          ~/.pnpm-store
          common/temp
          ./common/temp/node_modules/
        key: ${{ runner.os }}-modules-node16-v2-${{ hashFiles('**/pnpm-lock.yaml') }}
    - name: Add local rush scripts to PATH
      run: echo "${PWD}"/common/scripts >> $GITHUB_PATH
    - name: Install packages
      run: rush update
    - name: Build packages
      run: rush build
    - name: Lint all the packages
      run: rush lint:strict
    - name: Typecheck all the packages
      if: success() || failure()
      run: rush typecheck
  check-i18n-sync:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: build-cr-sqlite
    permissions:
      id-token: write
      contents: read
      checks: write
    steps:
    - name: Checkout repository and submodules
      uses: actions/checkout@v4
      with:
        submodules: recursive
        lfs: false
    - uses: actions/setup-node@v4
      with:
        node-version: "20"
    - uses: actions/download-artifact@v4
      with:
        name: built-vlcn-artefacts
        path: 3rd-party/artefacts
      if: ${{ !cancelled() && needs.build-cr-sqlite.outputs.rebuild == 'yes' }}
    - name: Load cached cr-sqlite artefacts
      uses: actions/cache/restore@v4
      with:
        path: 3rd-party/artefacts
        key: ${{ runner.os }}-cr-sqlite-artefacts-${{ hashFiles('3rd-party/artefacts_version.txt') }}
    - name: Cache node modules
      uses: actions/cache@v4
      with:
        path: |
          ~/.rush
          ~/.pnpm-store
          common/temp
          ./common/temp/node_modules/
        key: ${{ runner.os }}-modules-node16-v2-${{ hashFiles('**/pnpm-lock.yaml') }}
    - name: Add local rush scripts to PATH
      run: echo "${PWD}"/common/scripts >> $GITHUB_PATH
    - name: Install packages
      run: rush update
    - name: Build packages
      run: rush build
    - name: Run the check
      run: cd pkg/shared && rushx typesafe-i18n-check
  perform-monorepo-checks:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: build-cr-sqlite
    steps:
    - name: Checkout repository and submodules
      uses: actions/checkout@v4
      with:
        submodules: recursive
        lfs: false
    - uses: actions/setup-node@v4
      with:
        node-version: "20"
    - uses: actions/download-artifact@v4
      with:
        name: built-vlcn-artefacts
        path: 3rd-party/artefacts
      if: ${{ !cancelled() && needs.build-cr-sqlite.outputs.rebuild == 'yes' }}
    - name: Load cached cr-sqlite artefacts
      uses: actions/cache/restore@v4
      with:
        path: 3rd-party/artefacts
        key: ${{ runner.os }}-cr-sqlite-artefacts-${{ hashFiles('3rd-party/artefacts_version.txt') }}
    - name: Cache node modules
      uses: actions/cache@v4
      with:
        path: |
          ~/.rush
          ~/.pnpm-store
          common/temp
          ./common/temp/node_modules/
        key: ${{ runner.os }}-modules-node16-v2-${{ hashFiles('**/pnpm-lock.yaml') }}
    - name: Add local rush scripts to PATH
      run: echo "${PWD}"/common/scripts >> $GITHUB_PATH
    - name: Install packages
      run: rush update
    - name: Build packages
      run: rush build
    - name: Check for unlisted artifacts in 'apps' and 'pkg' folders
      run: rush check-workspace-projects
  deploy-preview:
    name: Deploy preview web-client app to R2
    runs-on: ubuntu-latest
    needs: build-cr-sqlite
    steps:
    - name: Checkout repository and submodules
      uses: actions/checkout@v4
      with:
        submodules: recursive
        lfs: false
    - uses: actions/setup-node@v4
      with:
        node-version: "20"
    - name: compute desired compiled artifact version
      run: ./scripts/compute_artefacts_version.sh
    - uses: actions/download-artifact@v4
      with:
        name: built-vlcn-artefacts
        path: 3rd-party/artefacts
      if: ${{ !cancelled() && needs.build-cr-sqlite.outputs.rebuild == 'yes' }}
    - name: Load cached cr-sqlite artefacts
      uses: actions/cache/restore@v4
      with:
        path: 3rd-party/artefacts
        key: ${{ runner.os }}-cr-sqlite-artefacts-${{ hashFiles('3rd-party/artefacts_version.txt') }}
    - name: Cache node modules
      uses: actions/cache@v4
      with:
        path: |
          ~/.rush
          ~/.pnpm-store
          common/temp
          ./common/temp/node_modules/
        key: ${{ runner.os }}-modules-node16-v2-${{ hashFiles('**/pnpm-lock.yaml') }}
    - name: Add local rush scripts to PATH
      run: echo "${PWD}"/common/scripts >> $GITHUB_PATH
    - name: Install packages
      run: rush update
    - name: Build packages
      run: rush build
    - name: Prepare Weblate env (only for weblate branches)
      if: contains(github.head_ref || github.ref_name, 'weblate')
      run: |
        echo "PUBLIC_WEBLATE_API_KEY=${{ secrets.PUBLIC_WEBLATE_API_KEY }}" >> "$GITHUB_ENV"
        echo "PUBLIC_WEBLATE_COMPONENT_URL=${{ vars.PUBLIC_WEBLATE_COMPONENT_URL }}" >> "$GITHUB_ENV"
    - name: Build web-client app using prefix ${{ github.head_ref || github.ref_name }}
      run: cd apps/web-client && rushx build:prod
      env:
        BASE_PATH: /${{ github.head_ref || github.ref_name }}
        SENTRY_ORG: code-myriad
        SENTRY_PROJECT: librocco
        SENTRY_URL: https://sentry.libroc.co
        SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
        PUBLIC_SENTRY_DSN: ${{ secrets.PUBLIC_SENTRY_DSN }}
    - name: Install and configure rclone for R2
      run: |
        wget -q https://downloads.rclone.org/v1.71.1/rclone-v1.71.1-linux-amd64.zip
        unzip -q rclone-v1.71.1-linux-amd64.zip
        sudo mv rclone-v1.71.1-linux-amd64/rclone /usr/local/bin/rclone
        sudo chmod +x /usr/local/bin/rclone
        rm -rf rclone-v1.71.1-linux-amd64.zip rclone-v1.71.1-linux-amd64

        mkdir -p ~/.config/rclone
        cat > ~/.config/rclone/rclone.conf <<EOF
        [r2]
        type = s3
        provider = Cloudflare
        access_key_id = ${CLOUDFLARE_ACCESS_KEY_ID}
        secret_access_key = ${CLOUDFLARE_SECRET_ACCESS_KEY}
        endpoint = ${CLOUDFLARE_BUCKET_URL}
        acl = public-read
        no_check_bucket = true
        EOF
      env:
        CLOUDFLARE_ACCESS_KEY_ID: ${{ secrets.CLOUDFLARE_ACCESS_KEY_ID }}
        CLOUDFLARE_SECRET_ACCESS_KEY: ${{ secrets.CLOUDFLARE_SECRET_ACCESS_KEY }}
        CLOUDFLARE_BUCKET_URL: ${{ secrets.CLOUDFLARE_BUCKET_URL }}
    - name: 'Upload to R2: apps/web-client/build/ -> ${{ github.head_ref || github.ref_name }}/'
      run: rclone copy apps/web-client/build/ r2:librocco-ci/${{ github.head_ref || github.ref_name }}/
    - name: Output link to deployed app
      run: echo You can view the app on https://test.libroc.co/${{ github.head_ref || github.ref_name }}/index.html | tee -a $GITHUB_STEP_SUMMARY
  e2e-merge-report:
    if: ${{ !cancelled() }}
    needs:
    - e2e-test
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository and submodules
      uses: actions/checkout@v4
      with:
        submodules: recursive
        lfs: false
    - uses: actions/setup-node@v4
      with:
        node-version: "20"
    - name: Download blob reports
      uses: actions/download-artifact@v4
      with:
        path: all-blob-reports
        pattern: e2e-blob-report-*
        merge-multiple: true
    - name: Merge to HTML report
      run: npx playwright merge-reports --reporter html ./all-blob-reports
    - name: Install and configure rclone for R2
      run: |
        wget -q https://downloads.rclone.org/v1.71.1/rclone-v1.71.1-linux-amd64.zip
        unzip -q rclone-v1.71.1-linux-amd64.zip
        sudo mv rclone-v1.71.1-linux-amd64/rclone /usr/local/bin/rclone
        sudo chmod +x /usr/local/bin/rclone
        rm -rf rclone-v1.71.1-linux-amd64.zip rclone-v1.71.1-linux-amd64

        mkdir -p ~/.config/rclone
        cat > ~/.config/rclone/rclone.conf <<EOF
        [r2]
        type = s3
        provider = Cloudflare
        access_key_id = ${CLOUDFLARE_ACCESS_KEY_ID}
        secret_access_key = ${CLOUDFLARE_SECRET_ACCESS_KEY}
        endpoint = ${CLOUDFLARE_BUCKET_URL}
        acl = public-read
        no_check_bucket = true
        EOF
      env:
        CLOUDFLARE_ACCESS_KEY_ID: ${{ secrets.CLOUDFLARE_ACCESS_KEY_ID }}
        CLOUDFLARE_SECRET_ACCESS_KEY: ${{ secrets.CLOUDFLARE_SECRET_ACCESS_KEY }}
        CLOUDFLARE_BUCKET_URL: ${{ secrets.CLOUDFLARE_BUCKET_URL }}
    - name: 'Upload to R2: playwright-report/ -> ${{ github.head_ref || github.ref_name }}/tests/'
      run: rclone copy playwright-report/ r2:librocco-ci/${{ github.head_ref || github.ref_name }}/tests/
    - uses: actions/upload-artifact@v4
      if: always()
      with:
        name: e2e-merged-html-report
        path: playwright-report
        retention-days: 30
    - name: Output link to report
      run: echo "Merged e2e report https://test.libroc.co/${{ github.head_ref || github.ref_name }}/tests/index.html" | tee -a $GITHUB_STEP_SUMMARY
  deploy-demo:
    name: Deploy demo web-client app to R2
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/production-demo'
    needs:
    - build-cr-sqlite
    - js-search-test
    - book-data-extension-test
    - web-client-test
    - e2e-test
    - lint-and-typecheck
    - check-i18n-sync
    - perform-monorepo-checks
    steps:
    - name: Checkout repository and submodules
      uses: actions/checkout@v4
      with:
        submodules: recursive
        lfs: false
    - uses: actions/setup-node@v4
      with:
        node-version: "20"
    - name: compute desired compiled artifact version
      run: ./scripts/compute_artefacts_version.sh
    - uses: actions/download-artifact@v4
      with:
        name: built-vlcn-artefacts
        path: 3rd-party/artefacts
      if: ${{ !cancelled() && needs.build-cr-sqlite.outputs.rebuild == 'yes' }}
    - name: Load cached cr-sqlite artefacts
      uses: actions/cache/restore@v4
      with:
        path: 3rd-party/artefacts
        key: ${{ runner.os }}-cr-sqlite-artefacts-${{ hashFiles('3rd-party/artefacts_version.txt') }}
    - name: Cache node modules
      uses: actions/cache@v4
      with:
        path: |
          ~/.rush
          ~/.pnpm-store
          common/temp
          ./common/temp/node_modules/
        key: ${{ runner.os }}-modules-node16-v2-${{ hashFiles('**/pnpm-lock.yaml') }}
    - name: Add local rush scripts to PATH
      run: echo "${PWD}"/common/scripts >> $GITHUB_PATH
    - name: Install packages
      run: rush update
    - name: Build packages
      run: rush build
    - name: Build web-client app
      run: cd apps/web-client && rushx build:prod
      env:
        BASE_PATH: /demo
        SENTRY_ORG: code-myriad
        SENTRY_PROJECT: librocco
        SENTRY_URL: https://sentry.libroc.co
        SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
        PUBLIC_SENTRY_DSN: ${{ secrets.PUBLIC_SENTRY_DSN }}
        PUBLIC_IS_DEMO: "true"
        PUBLIC_DEMO_DB_URL: https://librocco.codemyriad.io/demo_db.sqlite3
    - name: Install and configure rclone for R2
      run: |
        wget -q https://downloads.rclone.org/v1.71.1/rclone-v1.71.1-linux-amd64.zip
        unzip -q rclone-v1.71.1-linux-amd64.zip
        sudo mv rclone-v1.71.1-linux-amd64/rclone /usr/local/bin/rclone
        sudo chmod +x /usr/local/bin/rclone
        rm -rf rclone-v1.71.1-linux-amd64.zip rclone-v1.71.1-linux-amd64

        mkdir -p ~/.config/rclone
        cat > ~/.config/rclone/rclone.conf <<EOF
        [r2]
        type = s3
        provider = Cloudflare
        access_key_id = ${CLOUDFLARE_ACCESS_KEY_ID}
        secret_access_key = ${CLOUDFLARE_SECRET_ACCESS_KEY}
        endpoint = ${CLOUDFLARE_BUCKET_URL}
        acl = public-read
        no_check_bucket = true
        EOF
      env:
        CLOUDFLARE_ACCESS_KEY_ID: ${{ secrets.CLOUDFLARE_ACCESS_KEY_ID }}
        CLOUDFLARE_SECRET_ACCESS_KEY: ${{ secrets.CLOUDFLARE_SECRET_ACCESS_KEY }}
        CLOUDFLARE_BUCKET_URL: ${{ secrets.CLOUDFLARE_BUCKET_URL }}
    - name: 'Upload to R2: apps/web-client/build/ -> demo/'
      run: rclone copy apps/web-client/build/ r2:librocco-ci/demo/
    - name: Output link to deployed demo app
      run: echo You can view the demo app on https://libroc.co/demo | tee -a $GITHUB_STEP_SUMMARY
