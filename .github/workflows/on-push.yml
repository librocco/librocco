name: Checks
"on":
  push:
    branches-ignore:
      - ci-debug/*
      - wip/**
jobs:
  compile-cr-sqlite:
    name: Compile cr-sqlite
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      id-token: write
      contents: read
      checks: write
    steps:
      - name: Checkout repository and submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive
          lfs: true
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install Rust 1.70.0
        # I was getting this:
        # error: older versions of the `wasm-bindgen` crate are incompatible with current versions of Rust; please update to `wasm-bindgen` v0.2.88
        # and for now I decided to downgrade rust instead of upgrading wasm-bindgen
        uses: actions-rs/toolchain@v1
        with:
          toolchain: 1.70.0
          override: true
      - name: install wasm-pack 0.10.2
        run: cargo install wasm-pack --version 0.10.2
      - name: Build cr-sqlite
        run: ./build_vlcn.sh
      - name: Check that the build went fine
        run: git status; ls -l 3rd-party/artefacts/
      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.rush
            ~/.pnpm-store
            common/temp
            ./common/temp/node_modules/
          key: ${{ runner.os }}-modules-node16-v2-${{ hashFiles('**/pnpm-lock.yaml') }}
      - name: Add local rush scripts to PATH
        run: echo "${PWD}"/common/scripts >> $GITHUB_PATH
      - name: Install packages
        run: rush update
      - name: Build packages
        run: rush build
      - name: Run tests
        run: cd apps/web-client && rushx test:ci
