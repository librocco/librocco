name: PyInstaller Build
"on":
  push:
    paths:
    - python-apps/**
    - .github/workflows/pyinstaller-build.yml
  workflow_dispatch: null
jobs:
  build-executable:
    name: Build ${{ matrix.os }}-${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        include:
        - os: linux
          arch: x64
          runner: ubuntu-22.04
          artifact_name: librocco-launcher-linux-x64
        - os: macos
          arch: x64
          runner: macos-15-intel
          artifact_name: librocco-launcher-macos-x64
        - os: macos
          arch: arm64
          runner: macos-15
          artifact_name: librocco-launcher-macos-arm64
    steps:
    - name: Checkout repository and submodules
      uses: actions/checkout@v4
      with:
        submodules: recursive
        lfs: true
    - uses: actions/setup-node@v4
      with:
        node-version: "20"
    - name: Download Windows crsqlite.dll (workaround)
      if: runner.os == 'Windows'
      continue-on-error: true
      id: download-windows-dll
      uses: actions/download-artifact@v4
      with:
        name: crsqlite-windows-dll
        path: temp-crsqlite-dll
    - name: Inject Windows crsqlite.dll into tarball (workaround)
      if: runner.os == 'Windows' && steps.download-windows-dll.outcome == 'success'
      shell: pwsh
      run: |
        # Extract the tarball
        $tarball = "3rd-party/artefacts/vlcn.io-crsqlite-0.16.1.tgz"
        $tempDir = "temp-crsqlite-inject"

        New-Item -ItemType Directory -Force -Path $tempDir
        tar -xzf $tarball -C $tempDir

        # Create dist directory in the package
        New-Item -ItemType Directory -Force -Path "$tempDir/package/dist"

        # Copy our pre-built dll
        Copy-Item "temp-crsqlite-dll/crsqlite.dll" "$tempDir/package/dist/crsqlite.dll"

        # Repack the tarball with the dll included
        tar -czf $tarball -C $tempDir package

        Write-Host "Injected crsqlite.dll into tarball"

        # Cleanup
        Remove-Item -Recurse -Force $tempDir
        Remove-Item -Recurse -Force temp-crsqlite-dll
    - name: Install uv
      uses: astral-sh/setup-uv@v7
      with:
        enable-cache: true
        python-version: "3.13"
        cache-python: true
        working-directory: python-apps/launcher
    - name: Cache node modules
      uses: actions/cache@v4
      with:
        path: |
          ~/.rush
          ~/.pnpm-store
          common/temp
          ./common/temp/node_modules/
        key: ${{ runner.os }}-modules-node20-v3-${{ hashFiles('**/pnpm-lock.yaml') }}
    - name: Install Rush
      run: npm install -g @microsoft/rush
    - name: Add local rush scripts to PATH
      run: echo "${PWD}"/common/scripts >> $GITHUB_PATH
    - name: Install packages
      run: rush update
    - name: Build packages
      run: |
        set +e
        rush build
        exit_code=$?
        if [ $exit_code -eq 0 ] || [ $exit_code -eq 1 ]; then
          echo "Build completed (exit code: $exit_code)"
          exit 0
        else
          echo "Build failed with exit code: $exit_code"
          exit $exit_code
        fi
    - name: Build web-client for root path
      run: cd apps/web-client && rushx build:prod-rootdir
      shell: bash
    - name: Create virtual environment and install launcher
      run: |
        cd python-apps/launcher
        uv venv --python 3.13 --python-preference only-managed
        uv pip install -e '.[build]'
      shell: bash
    - name: Build PyInstaller executable
      env:
        MACOSX_DEPLOYMENT_TARGET: "10.14"
      run: |
        cd python-apps/launcher
        source .venv/bin/activate
        python scripts/build_executable.py
      shell: bash
    - name: Upload executable artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: |
          python-apps/launcher/dist/librocco-launcher*
        retention-days: 90
        if-no-files-found: error
    - name: Install Linux dependencies
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y libegl1-mesa
    - name: Start launcher
      if: runner.os != 'Windows'
      env:
        QT_QPA_PLATFORM: offscreen
      run: |
        cd python-apps/launcher/dist
        ./librocco-launcher > launcher.log 2>&1 &
        echo $! > launcher.pid
      shell: bash
    - name: Check for launcher initialization errors
      if: runner.os != 'Windows'
      run: |
        cd python-apps/launcher/dist

        echo "Waiting for tray application to initialize..."
        # Wait up to 30 seconds for "Starting tray application..." to appear
        for i in {1..30}; do
          if grep -q "Starting tray application" launcher.log 2>/dev/null; then
            echo "Tray initialization started, waiting a bit more..."
            sleep 2
            break
          fi
          sleep 1
        done

        # Check if launcher process is still running
        if [ -f launcher.pid ]; then
          LAUNCHER_PID=$(cat launcher.pid)
          if ! kill -0 $LAUNCHER_PID 2>/dev/null; then
            echo "ERROR: Launcher process died shortly after startup"
            echo "--- Launcher Output ---"
            cat launcher.log
            exit 1
          fi
        fi

        # Check for Python tracebacks in output
        if grep -q "Traceback" launcher.log; then
          echo "ERROR: Found Python traceback in launcher output"
          echo "--- Launcher Output ---"
          cat launcher.log
          exit 1
        fi

        echo "Launcher initialized successfully (no tracebacks detected)"
      shell: bash
    - name: Verify Caddy responds
      run: |
        echo "Waiting for Caddy to respond..."
        for i in {1..60}; do
          if curl --silent --show-error --fail --insecure https://localhost:8080/; then
            echo "Caddy is responding."
            exit 0
          fi
          echo "Attempt $i failed. Retrying in 1 second..."
          sleep 1
        done
        echo "Caddy did not respond after 60 seconds."
        exit 1
    - name: Display Launcher Logs
      if: always() && runner.os != 'Windows'
      run: |
        cd python-apps/launcher/dist
        if [ -f launcher.log ]; then
          echo "--- Launcher Output (stdout/stderr) ---"
          cat launcher.log
        else
          echo "launcher.log not found"
        fi
      shell: bash
    - name: Display Caddy Logs
      if: always()
      run: |
        if [[ "$RUNNER_OS" == "Linux" ]]; then
          LOG_DIR="/home/runner/.local/share/librocco-launcher/logs"
        elif [[ "$RUNNER_OS" == "macOS" ]]; then
          LOG_DIR="/Users/runner/.librocco-launcher/logs"
        else
          echo "Unsupported OS for log dumping."
          exit 0
        fi

        if [ -d "$LOG_DIR" ]; then
          echo "--- Caddy log directory contents ($LOG_DIR) ---"
          ls -la "$LOG_DIR"
          echo "--- caddy-server.log ---"
          cat "$LOG_DIR/caddy-server.log" || echo "caddy-server.log not found."
          echo "--- caddy-access.log ---"
          cat "$LOG_DIR/caddy-access.log" || echo "caddy-access.log not found."
        else
          echo "Log directory not found: $LOG_DIR"
        fi
      shell: bash
