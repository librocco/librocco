name: PyInstaller Build
"on":
  push:
    paths:
    - python-apps/**
    - .github/workflows/pyinstaller-build.yml
  workflow_dispatch: null
jobs:
  build-cr-sqlite:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      rebuild: ${{ steps.ts.outputs.rebuild }}
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
        lfs: false
        fetch-depth: 0
    - name: Test if artefacts are stale
      id: ts
      shell: bash
      run: echo "rebuild=yes" >> "$GITHUB_OUTPUT"
    - uses: actions/setup-node@v4
      if: steps.ts.outputs.rebuild == 'yes'
      with:
        node-version: "20"
    - name: Install Rust Toolchain
      if: steps.ts.outputs.rebuild == 'yes'
      uses: actions-rs/toolchain@v1
      with:
        toolchain: nightly-2023-10-05
        override: true
    - name: install wasm-pack
      if: steps.ts.outputs.rebuild == 'yes'
      run: cargo install wasm-pack --version 0.13.1 --locked
    - name: install pnpm
      if: steps.ts.outputs.rebuild == 'yes'
      run: npm install -g 'pnpm@<9'
    - name: Build cr-sqlite
      if: steps.ts.outputs.rebuild == 'yes'
      run: ./scripts/build_vlcn.sh
    - name: Check that the build went fine
      run: git status; ls -l 3rd-party/artefacts/
    - name: upload to later jobs
      if: steps.ts.outputs.rebuild == 'yes'
      uses: actions/upload-artifact@v4
      with:
        name: built-vlcn-artefacts
        path: 3rd-party/artefacts/
    - name: Mark cached version
      run: cp 3rd-party/artefacts_version.txt 3rd-party/artefacts/version-cached.txt
    - name: Commit updated assets
      if: github.ref == 'refs/heads/compile-assets'
      run: bash scripts/commit-artefacts.sh
    - name: Push changes
      if: github.ref == 'refs/heads/compile-assets'
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: compile-assets
  build-windows-crsqlite:
    runs-on: windows-latest
    outputs:
      artifact_name: ${{ steps.output.outputs.artifact_name }}
    steps:
    - name: Install Rust Toolchain
      uses: actions-rs/toolchain@v1
      with:
        toolchain: nightly-2023-10-05
        target: x86_64-pc-windows-msvc
        override: true
    - name: Configure git for HTTPS
      shell: bash
      run: |
        git config --global url."https://github.com/".insteadOf "git@github.com:"
    - name: Clone cr-sqlite repository
      shell: pwsh
      run: |
        git clone --recurse-submodules --depth 1 --branch v0.16.1 https://github.com/vlcn-io/cr-sqlite.git cr-sqlite-build

        if ($LASTEXITCODE -ne 0) {
          Write-Error "Git clone failed"
          exit 1
        }

        Set-Location cr-sqlite-build
        git log -1 --oneline
        Get-ChildItem
    - name: Build crsqlite.dll with make
      shell: bash
      working-directory: cr-sqlite-build/core
      run: |
        # Try using make (might work with Git Bash on Windows)
        make loadable || {
          echo "Make failed, will try manual build next"
          exit 1
        }

        ls -la dist/
    - name: Upload Windows crsqlite.dll
      uses: actions/upload-artifact@v4
      with:
        name: crsqlite-windows-dll
        path: cr-sqlite-build/core/dist/crsqlite.dll
        retention-days: 90
        if-no-files-found: error
    - name: Set output
      id: output
      shell: bash
      run: echo "artifact_name=crsqlite-windows-dll" >> "$GITHUB_OUTPUT"
  build-executable:
    needs:
    - build-cr-sqlite
    if: ${{ !cancelled() }}
    name: Build ${{ matrix.os }}-${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        include:
        - os: linux
          arch: x64
          runner: ubuntu-22.04
          artifact_name: librocco-launcher-linux-x64
        - os: macos
          arch: x64
          runner: macos-13
          artifact_name: librocco-launcher-macos-x64
        - os: macos
          arch: arm64
          runner: macos-14
          artifact_name: librocco-launcher-macos-arm64
        - os: windows
          arch: x64
          runner: windows-latest
          artifact_name: librocco-launcher-windows-x64
    steps:
    - name: Checkout repository and submodules
      uses: actions/checkout@v4
      with:
        submodules: recursive
        lfs: false
    - uses: actions/setup-node@v4
      with:
        node-version: "20"
    - name: Compute desired compiled artifact version
      run: ./scripts/compute_artefacts_version.sh
    - uses: actions/download-artifact@v4
      with:
        name: built-vlcn-artefacts
        path: 3rd-party/artefacts
      if: ${{ !cancelled() && needs.build-cr-sqlite.outputs.rebuild == 'yes' }}
    - name: Load cached cr-sqlite artefacts
      uses: actions/cache/restore@v4
      with:
        path: 3rd-party/artefacts
        key: ${{ runner.os }}-cr-sqlite-artefacts-${{ hashFiles('3rd-party/artefacts_version.txt') }}
    - name: Download Windows crsqlite.dll (workaround)
      if: runner.os == 'Windows'
      continue-on-error: true
      id: download-windows-dll
      uses: actions/download-artifact@v4
      with:
        name: crsqlite-windows-dll
        path: temp-crsqlite-dll
    - name: Inject Windows crsqlite.dll into tarball (workaround)
      if: runner.os == 'Windows' && steps.download-windows-dll.outcome == 'success'
      shell: pwsh
      run: |
        # Extract the tarball
        $tarball = "3rd-party/artefacts/vlcn.io-crsqlite-0.16.1.tgz"
        $tempDir = "temp-crsqlite-inject"

        New-Item -ItemType Directory -Force -Path $tempDir
        tar -xzf $tarball -C $tempDir

        # Create dist directory in the package
        New-Item -ItemType Directory -Force -Path "$tempDir/package/dist"

        # Copy our pre-built dll
        Copy-Item "temp-crsqlite-dll/crsqlite.dll" "$tempDir/package/dist/crsqlite.dll"

        # Repack the tarball with the dll included
        tar -czf $tarball -C $tempDir package

        Write-Host "Injected crsqlite.dll into tarball"

        # Cleanup
        Remove-Item -Recurse -Force $tempDir
        Remove-Item -Recurse -Force temp-crsqlite-dll
    - name: Install uv
      uses: astral-sh/setup-uv@v5
      with:
        enable-cache: true
    - name: Cache node modules
      uses: actions/cache@v4
      with:
        path: |
          ~/.rush
          ~/.pnpm-store
          common/temp
          ./common/temp/node_modules/
        key: ${{ runner.os }}-modules-node16-v2-${{ hashFiles('**/pnpm-lock.yaml') }}
    - name: Install Rush
      run: npm install -g @microsoft/rush
    - name: Add local rush scripts to PATH
      run: echo "${PWD}"/common/scripts >> $GITHUB_PATH
    - name: Install packages
      run: rush update
    - name: Build packages
      run: rush build
    - name: Build web-client for root path
      run: cd apps/web-client && rushx build:prod-rootdir
      shell: bash
    - name: Create virtual environment and install launcher
      run: |
        cd python-apps/launcher
        uv venv --python 3.13 --python-preference only-managed
        uv pip install -e '.[build]'
      shell: bash
    - name: Build PyInstaller executable
      run: |
        cd python-apps/launcher
        source .venv/bin/activate
        python scripts/build_executable.py
      shell: bash
    - name: Upload executable artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: |
          python-apps/launcher/dist/librocco-launcher*
        retention-days: 90
        if-no-files-found: error
    - name: Smoke test (Unix)
      if: runner.os != 'Windows'
      run: |
        cd python-apps/launcher/dist
        chmod +x librocco-launcher
        timeout 5 ./librocco-launcher --help || true
      shell: bash
    - name: Smoke test (Windows)
      if: runner.os == 'Windows'
      run: |
        cd python-apps/launcher/dist
        if (Test-Path librocco-launcher.exe) {
          Write-Host "Executable built successfully"
        } else {
          Write-Error "Executable not found!"
          exit 1
        }
      shell: pwsh
