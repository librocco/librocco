name: VFS Benchmark
"on":
  push:
    branches:
    - vfs-benchmark/**
jobs:
  build-cr-sqlite:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      rebuild: ${{ steps.ts.outputs.rebuild }}
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
        lfs: true
        fetch-depth: 0
    - name: Test if artefacts are stale
      id: ts
      shell: bash
      run: scripts/compare_artefacts_version.sh >> "$GITHUB_OUTPUT"
    - uses: actions/setup-node@v4
      if: steps.ts.outputs.rebuild == 'yes'
      with:
        node-version: "22"
    - name: Install Rust Toolchain
      if: steps.ts.outputs.rebuild == 'yes'
      uses: actions-rs/toolchain@v1
      with:
        toolchain: nightly-2023-10-05
        override: true
    - name: install wasm-pack
      if: steps.ts.outputs.rebuild == 'yes'
      run: cargo install wasm-pack --version 0.13.1 --locked
    - name: install pnpm
      if: steps.ts.outputs.rebuild == 'yes'
      run: npm install -g 'pnpm@<9'
    - name: Build cr-sqlite
      if: steps.ts.outputs.rebuild == 'yes'
      run: ./scripts/build_vlcn.sh
    - name: Check that the build went fine
      run: git status; ls -l 3rd-party/artefacts/
    - name: upload to later jobs
      if: steps.ts.outputs.rebuild == 'yes'
      uses: actions/upload-artifact@v4
      with:
        name: built-vlcn-artefacts
        path: 3rd-party/artefacts/
    - name: Commit updated assets
      if: github.ref == 'refs/heads/compile-assets'
      run: bash scripts/commit-artefacts.sh
    - name: Push changes
      if: github.ref == 'refs/heads/compile-assets'
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: compile-assets
  vfs-benchmark:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    needs: build-cr-sqlite
    strategy:
      fail-fast: false
      matrix:
        shardIndex:
        - 1
        - 2
        - 3
        - 4
        - 5
        - 6
        - 7
        - 8
        - 9
        - 10
        shardTotal:
        - 10
    steps:
    - name: Checkout repository and submodules
      uses: actions/checkout@v4
      with:
        submodules: recursive
        lfs: true
    - uses: actions/setup-node@v4
      with:
        node-version: "22"
    - name: Compute desired compiled artifact version
      run: ./scripts/compute_artefacts_version.sh
    - uses: actions/download-artifact@v4
      with:
        name: built-vlcn-artefacts
        path: 3rd-party/artefacts
      if: ${{ !cancelled() && needs.build-cr-sqlite.outputs.rebuild == 'yes' }}
    - name: Load cached cr-sqlite artefacts
      uses: actions/cache/restore@v4
      with:
        path: 3rd-party/artefacts
        key: ${{ runner.os }}-cr-sqlite-artefacts-${{ hashFiles('3rd-party/artefacts_version.txt') }}
    - name: Cache node modules
      uses: actions/cache@v4
      with:
        path: |
          ~/.rush
          ~/.pnpm-store
          common/temp
          ./common/temp/node_modules/
        key: ${{ runner.os }}-modules-node20-v3-${{ hashFiles('**/pnpm-lock.yaml') }}
    - name: Add local rush scripts to PATH
      run: echo "${PWD}"/common/scripts >> $GITHUB_PATH
    - name: Install packages
      run: rush install
    - name: Build packages
      run: |
        set +e
        rush build
        exit_code=$?
        if [ $exit_code -eq 0 ] || [ $exit_code -eq 1 ]; then
          echo "Build completed (exit code: $exit_code)"
          exit 0
        else
          echo "Build failed with exit code: $exit_code"
          exit $exit_code
        fi
    - name: Build the app
      run: cd apps/web-client && rushx build:e2e
    - name: Download playwright browsers
      run: cd apps/e2e && npx playwright install
    - name: Run Playwright tests (shard ${{ matrix.shardIndex }}/${{ matrix.shardTotal }})
      run: cd apps/e2e && rushx test:vfs:ci
      env:
        PLAYWRIGHT_SHARD_INDEX: ${{ matrix.shardIndex }}
        PLAYWRIGHT_OPTIONS: --shard=${{ matrix.shardIndex }}/${{ matrix.shardTotal }}
    - uses: actions/upload-artifact@v4
      if: always()
      with:
        name: e2e-blob-report-${{ matrix.shardIndex }}
        path: apps/e2e/blob-report
        retention-days: 2
    - uses: actions/upload-artifact@v4
      if: always()
      with:
        name: e2e-json-report-${{ matrix.shardIndex }}.json
        path: apps/e2e/vfs-benchmark-results
        retention-days: 2
  parse-benchmarks:
    if: ${{ !cancelled() }}
    needs:
    - vfs-benchmark
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository and submodules
      uses: actions/checkout@v4
      with:
        submodules: recursive
        lfs: true
    - uses: actions/setup-node@v4
      with:
        node-version: "22"
    - name: Download JSON reports
      uses: actions/download-artifact@v4
      with:
        path: vfs-benchmark-results
        pattern: e2e-json-report-*
        merge-multiple: true
    - name: Parse reports and produce benchmarks
      run: ./scripts/parse-vfs-benchmarks vfs-benchmark-results
  e2e-merge-report:
    if: ${{ !cancelled() }}
    needs:
    - vfs-benchmark
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository and submodules
      uses: actions/checkout@v4
      with:
        submodules: recursive
        lfs: true
    - uses: actions/setup-node@v4
      with:
        node-version: "22"
    - name: Download blob reports
      uses: actions/download-artifact@v4
      with:
        path: all-blob-reports
        pattern: e2e-blob-report-*
        merge-multiple: true
    - name: Merge to HTML report
      run: npx playwright merge-reports --reporter html ./all-blob-reports
    - name: Install and configure rclone for R2
      run: |
        wget -q https://downloads.rclone.org/v1.71.1/rclone-v1.71.1-linux-amd64.zip
        unzip -q rclone-v1.71.1-linux-amd64.zip
        sudo mv rclone-v1.71.1-linux-amd64/rclone /usr/local/bin/rclone
        sudo chmod +x /usr/local/bin/rclone
        rm -rf rclone-v1.71.1-linux-amd64.zip rclone-v1.71.1-linux-amd64

        mkdir -p ~/.config/rclone
        cat > ~/.config/rclone/rclone.conf <<EOF
        [r2]
        type = s3
        provider = Cloudflare
        access_key_id = ${CLOUDFLARE_ACCESS_KEY_ID}
        secret_access_key = ${CLOUDFLARE_SECRET_ACCESS_KEY}
        endpoint = ${CLOUDFLARE_BUCKET_URL}
        acl = public-read
        no_check_bucket = true
        EOF
      env:
        CLOUDFLARE_ACCESS_KEY_ID: ${{ secrets.CLOUDFLARE_ACCESS_KEY_ID }}
        CLOUDFLARE_SECRET_ACCESS_KEY: ${{ secrets.CLOUDFLARE_SECRET_ACCESS_KEY }}
        CLOUDFLARE_BUCKET_URL: ${{ secrets.CLOUDFLARE_BUCKET_URL }}
    - name: 'Upload to R2: playwright-report/ -> ${{ github.head_ref || github.ref_name }}/tests/'
      run: rclone copy playwright-report/ r2:librocco-ci/${{ github.head_ref || github.ref_name }}/tests/
    - uses: actions/upload-artifact@v4
      if: always()
      with:
        name: e2e-merged-html-report
        path: playwright-report
        retention-days: 30
    - name: Output link to report
      run: echo "Merged e2e report https://test.libroc.co/${{ github.head_ref || github.ref_name }}/tests/index.html" | tee -a $GITHUB_STEP_SUMMARY
