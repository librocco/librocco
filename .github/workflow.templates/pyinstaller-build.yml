#@ load("github.lib.yml", "checkout")
#@ load("cache.lib.yml", "cache_node")
#@ load("rush.lib.yml", "rush_add_path")
#@ load("rush.lib.yml", "rush_install")
#@ load("rush.lib.yml", "rush_build")

name: PyInstaller Build

"on":
  push:
    paths:
      - "python-apps/**"
      - ".github/workflows/pyinstaller-build.yml"
  workflow_dispatch:

jobs:
  build-executable:
    name: Build ${{ matrix.os }}-${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        include:
          #! Linux builds - using ubuntu-22.04 for better glibc compatibility
          - os: linux
            arch: x64
            runner: ubuntu-22.04
            artifact_name: librocco-launcher-linux-x64
          #! NOTE: Linux ARM64 - GitHub doesn't provide native ARM64 runners yet
          #! We could use QEMU or cross-compilation, but skipping for now
          #! - os: linux
          #!   arch: arm64
          #!   runner: ubuntu-latest
          #!   artifact_name: librocco-launcher-linux-arm64

          #! macOS builds
          - os: macos
            arch: x64
            runner: macos-13 #! Intel runner
            artifact_name: librocco-launcher-macos-x64
          - os: macos
            arch: arm64
            runner: macos-14 #! Apple Silicon runner
            artifact_name: librocco-launcher-macos-arm64

          #! Windows builds
          #! DISABLED: Windows build currently not working, needs investigation
          #! - os: windows
          #!   arch: x64
          #!   runner: windows-latest
          #!   artifact_name: librocco-launcher-windows-x64
          #! NOTE: Windows ARM64 - GitHub doesn't provide ARM64 runners yet
          #! - os: windows
          #!   arch: arm64
          #!   runner: windows-latest
          #!   artifact_name: librocco-launcher-windows-arm64

    steps:
      -  #@ checkout()

      #! Node.js setup for web-client build
      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      #! TEMPORARY: Download pre-built Windows crsqlite.dll
      #! This step downloads the dll built in the build-windows-crsqlite job
      #! and places it where pnpm expects it, preventing the broken Makefile build
      #! Remove when upstream supports Windows MSVC builds
      - name: Download Windows crsqlite.dll (workaround)
        if: runner.os == 'Windows'
        continue-on-error: true
        id: download-windows-dll
        uses: actions/download-artifact@v4
        with:
          name: crsqlite-windows-dll
          path: temp-crsqlite-dll

      - name: Inject Windows crsqlite.dll into tarball (workaround)
        if: runner.os == 'Windows' && steps.download-windows-dll.outcome == 'success'
        shell: pwsh
        run: |
          # Extract the tarball
          $tarball = "3rd-party/artefacts/vlcn.io-crsqlite-0.16.1.tgz"
          $tempDir = "temp-crsqlite-inject"

          New-Item -ItemType Directory -Force -Path $tempDir
          tar -xzf $tarball -C $tempDir

          # Create dist directory in the package
          New-Item -ItemType Directory -Force -Path "$tempDir/package/dist"

          # Copy our pre-built dll
          Copy-Item "temp-crsqlite-dll/crsqlite.dll" "$tempDir/package/dist/crsqlite.dll"

          # Repack the tarball with the dll included
          tar -czf $tarball -C $tempDir package

          Write-Host "Injected crsqlite.dll into tarball"

          # Cleanup
          Remove-Item -Recurse -Force $tempDir
          Remove-Item -Recurse -Force temp-crsqlite-dll

      #! Install uv (which will manage Python installation)
      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      #! Cache node modules
      -  #@ cache_node()

      #! Install Rush globally
      - name: Install Rush
        run: npm install -g @microsoft/rush

      #! Add Rush scripts to PATH
      -  #@ rush_add_path()

      #! Build web client
      -  #@ rush_install()
      -  #@ rush_build()

      - name: Build web-client for root path
        run: cd apps/web-client && rushx build:prod-rootdir
        shell: bash

      #! Install Python launcher dependencies (needed for build scripts)
      #! Use uv-managed Python to ensure dev headers are available
      - name: Create virtual environment and install launcher
        run: |
          cd python-apps/launcher
          uv venv --python 3.13 --python-preference only-managed
          uv pip install -e '.[build]'
        shell: bash

      #! Build executable
      - name: Build PyInstaller executable
        run: |
          cd python-apps/launcher
          source .venv/bin/activate
          python scripts/build_executable.py
        shell: bash

      #! Upload artifacts
      - name: Upload executable artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: |
            python-apps/launcher/dist/librocco-launcher*
          retention-days: 90
          if-no-files-found: error

      #! Quick smoke test - just verify the executable exists and can show help
      - name: Smoke test (Unix)
        if: runner.os != 'Windows'
        run: |
          cd python-apps/launcher/dist
          chmod +x librocco-launcher
          timeout 5 ./librocco-launcher --help || true
        shell: bash

      - name: Smoke test (Windows)
        if: runner.os == 'Windows'
        run: |
          cd python-apps/launcher/dist
          if (Test-Path librocco-launcher.exe) {
            Write-Host "Executable built successfully"
          } else {
            Write-Error "Executable not found!"
            exit 1
          }
        shell: pwsh

      #! Integration test - verify launcher starts and Caddy responds
      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libegl1-mesa

      - name: Start launcher
        if: runner.os != 'Windows'
        env:
          QT_QPA_PLATFORM: offscreen
        run: |
          cd python-apps/launcher/dist
          ./librocco-launcher &
        shell: bash

      - name: Verify Caddy responds
        run: |
          echo "Waiting for Caddy to respond..."
          for i in {1..60}; do
            if curl --silent --show-error --fail --insecure https://localhost:8080/; then
              echo "Caddy is responding."
              exit 0
            fi
            echo "Attempt $i failed. Retrying in 1 second..."
            sleep 1
          done
          echo "Caddy did not respond after 60 seconds."
          exit 1

      - name: Display Caddy Logs
        if: always()
        run: |
          if [[ "$RUNNER_OS" == "Linux" ]]; then
            LOG_DIR="/home/runner/.local/share/librocco-launcher/logs"
          elif [[ "$RUNNER_OS" == "macOS" ]]; then
            LOG_DIR="/Users/runner/.librocco-launcher/logs"
          else
            echo "Unsupported OS for log dumping."
            exit 0
          fi

          if [ -d "$LOG_DIR" ]; then
            echo "--- Caddy log directory contents ($LOG_DIR) ---"
            ls -la "$LOG_DIR"
            echo "--- caddy-server.log ---"
            cat "$LOG_DIR/caddy-server.log" || echo "caddy-server.log not found."
            echo "--- caddy-access.log ---"
            cat "$LOG_DIR/caddy-access.log" || echo "caddy-access.log not found."
          else
            echo "Log directory not found: $LOG_DIR"
          fi
        shell: bash
