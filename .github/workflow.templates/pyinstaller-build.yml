#@ load("github.lib.yml", "checkout")
#@ load("github.lib.yml", "load_artefacts")
#@ load("cache.lib.yml", "cache_node")
#@ load("cache.lib.yml", "load_cached_artefacts")
#@ load("rush.lib.yml", "rush_add_path")
#@ load("rush.lib.yml", "rush_install")
#@ load("rush.lib.yml", "rush_build")
#@ load("build-crsqlite.lib.yml", "build_crsqlite")
#@ load("windows-crsqlite.lib.yml", "build_windows_crsqlite")

name: PyInstaller Build

"on":
  push:
    paths:
      - "python-apps/**"
      - ".github/workflows/pyinstaller-build.yml"
  workflow_dispatch:

jobs:
  build-cr-sqlite: #@ build_crsqlite()

  #! TEMPORARY: Build Windows crsqlite.dll separately
  #! Remove this job when upstream supports Windows MSVC builds
  build-windows-crsqlite: #@ build_windows_crsqlite()

  build-executable:
    #! Windows build needs the windows-crsqlite job, but don't block Linux/macOS if it fails
    needs: [build-cr-sqlite]
    #! Allow Windows build to proceed even if build-windows-crsqlite fails (will fail at rush update instead)
    if: ${{ !cancelled() }}
    name: Build ${{ matrix.os }}-${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        include:
          #! Linux builds - using ubuntu-22.04 for better glibc compatibility
          - os: linux
            arch: x64
            runner: ubuntu-22.04
            artifact_name: librocco-launcher-linux-x64
          #! NOTE: Linux ARM64 - GitHub doesn't provide native ARM64 runners yet
          #! We could use QEMU or cross-compilation, but skipping for now
          #! - os: linux
          #!   arch: arm64
          #!   runner: ubuntu-latest
          #!   artifact_name: librocco-launcher-linux-arm64

          #! macOS builds
          - os: macos
            arch: x64
            runner: macos-13  #! Intel runner
            artifact_name: librocco-launcher-macos-x64
          - os: macos
            arch: arm64
            runner: macos-14  #! Apple Silicon runner
            artifact_name: librocco-launcher-macos-arm64

          #! Windows builds
          - os: windows
            arch: x64
            runner: windows-latest
            artifact_name: librocco-launcher-windows-x64
          #! NOTE: Windows ARM64 - GitHub doesn't provide ARM64 runners yet
          #! - os: windows
          #!   arch: arm64
          #!   runner: windows-latest
          #!   artifact_name: librocco-launcher-windows-arm64

    steps:
      -  #@ checkout()

      #! Node.js setup for web-client build
      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      #! Compute cr-sqlite artefacts version
      - name: Compute desired compiled artifact version
        run: ./scripts/compute_artefacts_version.sh

      #! Load cr-sqlite artefacts (built or cached)
      -  #@ load_artefacts()
      -  #@ load_cached_artefacts()

      #! TEMPORARY: Download pre-built Windows crsqlite.dll
      #! This step downloads the dll built in the build-windows-crsqlite job
      #! and places it where pnpm expects it, preventing the broken Makefile build
      #! Remove when upstream supports Windows MSVC builds
      - name: Download Windows crsqlite.dll (workaround)
        if: runner.os == 'Windows'
        continue-on-error: true
        id: download-windows-dll
        uses: actions/download-artifact@v4
        with:
          name: crsqlite-windows-dll
          path: temp-crsqlite-dll

      - name: Inject Windows crsqlite.dll into tarball (workaround)
        if: runner.os == 'Windows' && steps.download-windows-dll.outcome == 'success'
        shell: pwsh
        run: |
          # Extract the tarball
          $tarball = "3rd-party/artefacts/vlcn.io-crsqlite-0.16.1.tgz"
          $tempDir = "temp-crsqlite-inject"

          New-Item -ItemType Directory -Force -Path $tempDir
          tar -xzf $tarball -C $tempDir

          # Create dist directory in the package
          New-Item -ItemType Directory -Force -Path "$tempDir/package/dist"

          # Copy our pre-built dll
          Copy-Item "temp-crsqlite-dll/crsqlite.dll" "$tempDir/package/dist/crsqlite.dll"

          # Repack the tarball with the dll included
          tar -czf $tarball -C $tempDir package

          Write-Host "Injected crsqlite.dll into tarball"

          # Cleanup
          Remove-Item -Recurse -Force $tempDir
          Remove-Item -Recurse -Force temp-crsqlite-dll

      #! Install uv (which will manage Python installation)
      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      #! Cache node modules
      -  #@ cache_node()

      #! Install Rush globally
      - name: Install Rush
        run: npm install -g @microsoft/rush

      #! Add Rush scripts to PATH
      -  #@ rush_add_path()

      #! Build web client
      -  #@ rush_install()
      -  #@ rush_build()

      - name: Build web-client for root path
        run: cd apps/web-client && rushx build:prod-rootdir
        shell: bash

      #! Install Python launcher dependencies (needed for build scripts)
      #! Use uv-managed Python to ensure dev headers are available
      - name: Create virtual environment and install launcher
        run: |
          cd python-apps/launcher
          uv venv --python 3.13 --python-preference only-managed
          uv pip install -e '.[build]'
        shell: bash

      #! Build executable
      - name: Build PyInstaller executable
        run: |
          cd python-apps/launcher
          source .venv/bin/activate
          python scripts/build_executable.py
        shell: bash

      #! Upload artifacts
      - name: Upload executable artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: |
            python-apps/launcher/dist/librocco-launcher*
          retention-days: 90
          if-no-files-found: error

      #! Quick smoke test - just verify the executable exists and can show help
      - name: Smoke test (Unix)
        if: runner.os != 'Windows'
        run: |
          cd python-apps/launcher/dist
          chmod +x librocco-launcher
          timeout 5 ./librocco-launcher --help || true
        shell: bash

      - name: Smoke test (Windows)
        if: runner.os == 'Windows'
        run: |
          cd python-apps/launcher/dist
          if (Test-Path librocco-launcher.exe) {
            Write-Host "Executable built successfully"
          } else {
            Write-Error "Executable not found!"
            exit 1
          }
        shell: pwsh
